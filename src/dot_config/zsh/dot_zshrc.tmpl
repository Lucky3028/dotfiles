typeset -U path PATH
path=(
  $path
  $HOME/bin(N-/)
  $HOME/.local/bin(N-/)
  $GHRD_DATA_HOME/bin(N-/)
  $XDG_DATA_HOME/mise/shims(N-/)
  $CARGO_HOME/bin(N-/)
  # Add code.exe to PATH for WSL
  /mnt/c/Users/*/AppData/Local/Programs/Microsoft\ VS\ Code/bin(N-/)
  # Add pwsh.exe to PATH for WSL
  /mnt/c/Program\ Files/PowerShell/7(N-/)
)

typeset -U fpath FPATH
fpath=(
  $fpath
  $ZDOTDIR/completions(N-/)
  $GHRD_DATA_HOME/completions(N-/)
)

# Load mise
eval "$($MISE_INSTALL_PATH activate zsh)"

# Load sheldon
eval "$(sheldon source)"

{{ if eq .chezmoi.os "linux" }}

# Run a script when it is NOT running in a container
if ! env | grep -q container; then

{{   if (.chezmoi.kernel.osrelease | lower | contains "microsoft") }}

  SSH_AGENT_FILE=~/.ssh/.ssh-agent

  if [ -f "$SSH_AGENT_FILE" ]; then
    source "$SSH_AGENT_FILE" > /dev/null
  fi
  if [ -z "$SSH_AGENT_PID" ] || ! kill -0 $SSH_AGENT_PID 2> /dev/null; then
    ssh-agent > "$SSH_AGENT_FILE"
    source "$SSH_AGENT_FILE" > /dev/null

    bw list items | jq -c '.[] | select(.type == 5)' | while IFS= read -r item; do
      name=$(printf '%s' "$item" | jq -r '.name')
      keyfile=$(mktemp --tmpdir "XXXXXX_${name}")
      printf '%s' "$item" | jq -r '.sshKey.privateKey' > "$keyfile"
      chmod 600 "$keyfile"
      ssh-add "$keyfile" > /dev/null 2>&1
      rm -f "$keyfile"
    done
  fi

{{   end }}

fi

{{ end }}
